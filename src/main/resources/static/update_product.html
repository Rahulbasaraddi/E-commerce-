<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Update Product</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="header">
    <div class="container wrap">
      <div class="brand">My E-Comm</div>
      <nav class="nav">
        <a class="btn ghost" href="index.html">Back</a>
        <a class="btn cart-btn" href="cart.html" id="cartBtn">Cart <span id="cartCount" class="cart-count">0</span></a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="form-panel">
      <h2 style="margin:0 0 12px">Update Product</h2>

      <form id="updateForm">
        <div class="form-row">
          <div style="flex:1" class="field"><label>Name</label><input name="name" type="text" required></div>
          <div style="flex:1" class="field"><label>Brand</label><input name="brand" type="text"></div>
        </div>

        <div class="field"><label>Description</label><textarea name="description"></textarea></div>

        <div class="form-row">
          <div style="flex:1" class="field"><label>Price</label><input name="price" type="number" step="0.01" required></div>
          <div style="flex:1" class="field"><label>Category</label><select name="category"></select></div>
        </div>

        <div class="form-row">
          <div style="flex:1" class="field"><label>Stock Quantity</label><input name="quantity" type="number" value="0"></div>
          <div style="flex:1" class="field"><label>Release Date</label><input name="releaseDate" type="date"></div>
          <div style="flex:1" class="field"><label>Image (choose to replace)</label><input name="imageFile" id="imageFileUpdate" type="file" accept="image/*"></div>
        </div>

        <label class="checkbox"><input type="checkbox" name="available"> Product Available</label>

        <div style="margin-top:12px">
          <button class="btn" type="submit">Update</button>
          <button type="button" class="btn ghost" onclick="location.href='index.html'">Cancel</button>
        </div>
      </form>
    </section>
  </main>

  <!-- header.js must be present and loaded before this script -->
  <script src="header.js"></script>
  <script>
    const API_BASE = '/api';
    const getParam = (k) => new URLSearchParams(location.search).get(k);
    const id = getParam('id');
    const PRODUCT_URL = `${API_BASE}/pro/${id}`;
    const UPDATE_URL = `${API_BASE}/pro/${id}`;
    const IMAGE_URL = `${API_BASE}/pro/${id}/image`;

    const form = document.getElementById('updateForm');
    let existingImageName = null;

    // load product and populate form
    async function loadProduct(){
      try {
        const res = await fetch(PRODUCT_URL);
        if(!res.ok) throw new Error('Product not found: ' + res.status);
        const p = await res.json();

        form.name.value = p.name || '';
        form.brand.value = p.brand || '';
        form.description.value = p.description || '';
        form.price.value = p.price ?? '';
        form.quantity.value = p.quantity ?? 0;
        if(p.releaseDate){
          const d = new Date(p.releaseDate);
          form.releaseDate.value = d.toISOString().slice(0,10);
        }
        form.available.checked = !!p.available;

        existingImageName = p.imageName || null;

        const cats = ['Electronics','Mobile','Home','Fashion'];
        const sel = form.category;
        sel.innerHTML = '';
        cats.forEach(c => {
          const o = document.createElement('option'); o.value = c; o.textContent = c;
          if(p.category === c) o.selected = true;
          sel.appendChild(o);
        });

        console.log('Product loaded', p);
      } catch(err){
        console.error('loadProduct error', err);
        alert('Cannot load product. Check backend.');
      }
    }

    // fetch existing image blob (or return null)
    async function fetchExistingImageBlob() {
      try {
        const resp = await fetch(IMAGE_URL);
        if(!resp.ok) return null;
        const blob = await resp.blob();
        const contentType = resp.headers.get('Content-Type') || 'application/octet-stream';
        // return blob and contentType (filename handled below)
        return { blob, contentType };
      } catch(e){
        console.warn('fetchExistingImageBlob failed', e);
        return null;
      }
    }

    // submit handler — ensures imageFile part is always present (backend requires it)
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if(!id){ alert('No product id'); return; }

      const fd = new FormData();
      const obj = {
        id: parseInt(id),
        name: form.name.value,
        brand: form.brand.value,
        description: form.description.value,
        price: parseFloat(form.price.value || 0),
        category: form.category.value,
        quantity: parseInt(form.quantity.value || 0),
        releaseDate: form.releaseDate.value || null,
        available: form.available.checked || false
      };

      // append product JSON
      fd.append('product', new Blob([JSON.stringify(obj)], { type: 'application/json' }));

      // check if user selected a new file
      const fileInput = document.getElementById('imageFileUpdate');
      const newFile = fileInput && fileInput.files && fileInput.files[0];

      try {
        if (newFile) {
          fd.append('imageFile', newFile);
        } else {
          // fetch existing image bytes and append them so backend gets imageFile part
          const existing = await fetchExistingImageBlob();
          if (existing && existing.blob) {
            const filename = existingImageName || `product-${id}.img`;
            fd.append('imageFile', existing.blob, filename);
          } else {
            // no existing image on server — append an empty blob to keep the part present
            fd.append('imageFile', new Blob([], { type: 'application/octet-stream' }), 'empty');
          }
        }

        // DEBUG: log FormData contents
        console.group('DEBUG: update FormData');
        for (const pair of fd.entries()) {
          const name = pair[0];
          const value = pair[1];
          if (value instanceof Blob) {
            console.log(name, '-> Blob size:', value.size, 'type:', value.type, 'name:', value.name || '(no name)');
          } else {
            console.log(name, '->', value);
          }
        }
        console.groupEnd();

        // send update
        const res = await fetch(UPDATE_URL, { method: 'PUT', body: fd });
        const text = await res.text();
        console.log('Update response', res.status, text);

        if (!res.ok) {
          alert('Update failed — see console/network tab. Server said: ' + (text || res.status));
          return;
        }

        alert('Updated');
        location.href = `product.html?id=${id}`;
      } catch (err) {
        console.error('Update error', err);
        alert('Update failed. Check backend console and network tab.');
      }
    });

    // bootstrap
    if (!id) {
      alert('No id provided');
    } else {
      loadProduct();
    }
  </script>
</body>
</html>
